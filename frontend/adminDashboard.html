<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - Sensor Cahaya</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Sedikit styling custom untuk legend / badge */
    .legend-box { display:inline-block; width:18px; height:12px; margin-right:8px; border-radius:3px; vertical-align:middle; }
    .bg-gelap { background:#2d3748; color:#fff; }
    .bg-redup { background:#6c757d; color:#fff; }
    .bg-terang { background:#ffd43b; color:#000; }
    .bg-terang-banget { background:#ffb703; color:#000; }
    .badge-custom { padding: .45rem .6rem; border-radius: .6rem; color: #fff; }
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">
        <i class="bi bi-speedometer2"></i> SensorCahaya App (Admin)
      </a>

      <div class="d-flex align-items-center text-white">
        <span id="userDisplay" class="me-3 fw-light">Loading...</span>
        <button id="btnLogout" class="btn btn-danger btn-sm rounded-pill px-3">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">

    <!-- KARTU SENSOR TERKINI -->
    <div class="row mb-4">
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-body text-center">
            <h6 class="text-muted mb-2">Pembacaan Terakhir</h6>
            <h1 id="latestLux" class="display-4 fw-bold text-primary">0 Lux</h1>
            <span id="latestStatus" class="badge bg-secondary rounded-pill px-3 py-2 mt-2">Menunggu Data...</span>
          </div>
        </div>
      </div>

      <!-- KETERANGAN STATUS -->
      <div class="col-md-6 mb-3">
        <div class="card h-100">
          <div class="card-header">
            <i class="bi bi-info-circle-fill text-primary"></i> Keterangan Status
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><span class="legend-box bg-gelap"></span> <strong>Gelap</strong> (üåë)</div>
                <span class="badge bg-light text-dark border">‚â§ 100 Lux</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><span class="legend-box bg-redup"></span> <strong>Redup</strong> (üå•Ô∏è)</div>
                <span class="badge bg-light text-dark border">101 - 300 Lux</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><span class="legend-box bg-terang"></span> <strong>Terang</strong> (‚òÄÔ∏è)</div>
                <span class="badge bg-light text-dark border">301 - 700 Lux</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div><span class="legend-box bg-terang-banget"></span> <strong>Terang Banget</strong> (üòé)</div>
                <span class="badge bg-light text-dark border">> 700 Lux</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN: MANAGEMEN USER -->
    <div class="card shadow-sm mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-people-fill"></i> Manajemen User (CRUD)</span>
        <div>
          <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#modalCreateUser">
            <i class="bi bi-person-plus"></i> Buat User
          </button>
          <button id="btnRefreshUsers" class="btn btn-sm btn-outline-primary ms-2">
            <i class="bi bi-arrow-clockwise"></i> Refresh Users
          </button>
        </div>
      </div>

      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">ID</th>
                <th>Username</th>
                <th>Role</th>
                <th class="text-end pe-4">Aksi</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <!-- akan diisi oleh JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TABEL RIWAYAT SENSOR -->
    <div class="card mb-4 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-table"></i> Riwayat Data Sensor</span>
        <div>
          <button id="btnRefreshSensor" class="btn btn-sm btn-outline-primary me-2">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="ps-4">ID</th>
                <th>Waktu (Timestamp)</th>
                <th>Nilai Lux</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="sensorTableBody">
              <!-- akan diisi oleh JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    

  </div>

  <!-- MODAL: CREATE USER -->
  <div class="modal fade" id="modalCreateUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formCreateUser" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Buat User Baru</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="createUserAlert"></div>
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input id="createUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input id="createPassword" type="password" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="createRole" class="form-select" required>
              <option value="user" selected>User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-success">Buat</button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL: EDIT USER -->
  <div class="modal fade" id="modalEditUser" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="formEditUser" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit User</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="editUserAlert"></div>
          <input type="hidden" id="editUserId">
          <div class="mb-3">
            <label class="form-label">Username</label>
            <input id="editUsername" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password <small class="text-muted">(Isi jika ingin ganti)</small></label>
            <input id="editPassword" type="password" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Role</label>
            <select id="editRole" class="form-select" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bootstrap JS (bundle) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Icons (Bootstrap Icons) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

  <script>
    // --- KONFIGURASI ---
    const API_URL = "http://localhost:3000/api";
    const role = localStorage.getItem('role');
    const username = localStorage.getItem('username');

    // Proteksi: hanya admin boleh buka adminDashboard.html
    if (!role) {
      window.location.href = 'login.html';
    } else if (role !== 'admin') {
      // jika bukan admin, redirect ke dashboard user biasa
      window.location.href = 'dashboard.html';
    }

    // Tampilkan user di navbar
    document.getElementById('userDisplay').innerText = `Halo, ${username || 'Admin'} (${role})`;

    // Logout button
    document.getElementById('btnLogout').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // Helper untuk menampilkan alert singkat di modal
    function setModalAlert(elId, message, type='danger') {
      const container = document.getElementById(elId);
      container.innerHTML = `<div class="alert alert-${type} py-2">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 3000);
    }

    // Formatting status berdasarkan nilai lux
    function getStatusInfo(lux) {
      if (lux <= 100) return { label: 'Gelap', class: 'bg-gelap', icon: 'üåë' };
      if (lux <= 300) return { label: 'Redup', class: 'bg-redup', icon: 'üå•Ô∏è' };
      if (lux <= 700) return { label: 'Terang', class: 'bg-terang', icon: '‚òÄÔ∏è' };
      return { label: 'Terang Banget', class: 'bg-terang-banget', icon: 'üòé' };
    }

    // --- SENSOR: Load & Render ---
    async function loadSensorData() {
      const tableBody = document.getElementById('sensorTableBody');
      const latestLuxEl = document.getElementById('latestLux');
      const latestStatusEl = document.getElementById('latestStatus');

      try {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Mengambil data...</td></tr>';
        const resp = await fetch(`${API_URL}/sensor?role=${role}`);
        if (resp.status === 403) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4 fw-bold">‚õî Akses Ditolak</td></tr>`;
          return;
        }
        const data = await resp.json();
        tableBody.innerHTML = '';

        if (!Array.isArray(data) || data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Belum ada data sensor.</td></tr>';
          latestLuxEl.innerText = '0 Lux';
          latestStatusEl.className = 'badge bg-secondary rounded-pill px-3 py-2 mt-2';
          latestStatusEl.innerText = 'Menunggu Data...';
          return;
        }

        // Asumsi data terurut terbaru di index 0
        const latest = data[0];
        if (latest) {
          const s = getStatusInfo(latest.nilai_lux);
          latestLuxEl.innerText = latest.nilai_lux + ' Lux';
          latestStatusEl.className = `badge rounded-pill px-3 py-2 mt-2 ${s.class}`;
          latestStatusEl.innerText = `${s.icon} ${s.label}`;
        }

        // Render rows
        for (const item of data) {
          const s = getStatusInfo(item.nilai_lux);
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="ps-4 fw-bold">#${item.id}</td>
            <td class="text-muted">${item.timestamp ? new Date(item.timestamp).toLocaleString() : '-'}</td>
            <td class="fw-bold text-primary">${item.nilai_lux} Lux</td>
            <td><span class="badge badge-custom ${s.class}">${s.icon} ${s.label}</span></td>
          `;
          tableBody.appendChild(row);
        }

      } catch (err) {
        console.error('Error loadSensorData', err);
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4">Gagal koneksi ke server</td></tr>`;
      }
    }

    // --- ADMIN: Users CRUD ---
    async function loadUsers() {
      const tbody = document.getElementById('usersTableBody');
      try {
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Mengambil user...</td></tr>';
        const resp = await fetch(`${API_URL}/admin/users?role=${role}`);
        if (resp.status === 403) {
          tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4 fw-bold">‚õî Akses Ditolak</td></tr>`;
          return;
        }
        const users = await resp.json();
        tbody.innerHTML = '';

        if (!Array.isArray(users) || users.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Belum ada user.</td></tr>';
          return;
        }

        for (const u of users) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="ps-4 fw-bold">#${u.id}</td>
            <td>${u.username}</td>
            <td class="text-uppercase fw-semibold">${u.role || 'user'}</td>
            <td class="text-end pe-4">
              <button class="btn btn-sm btn-outline-primary me-2" data-id="${u.id}" data-username="${u.username}" data-role="${u.role}" onclick="openEditModal(this)">Edit</button>
              <button class="btn btn-sm btn-outline-danger" data-id="${u.id}" onclick="deleteUser(${u.id})">Hapus</button>
            </td>
          `;
          tbody.appendChild(tr);
        }

      } catch (err) {
        console.error('Error loadUsers', err);
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4">Gagal koneksi ke server</td></tr>`;
      }
    }

    // CREATE user
    document.getElementById('formCreateUser').addEventListener('submit', async (e) => {
      e.preventDefault();
      const uname = document.getElementById('createUsername').value.trim();
      const pass = document.getElementById('createPassword').value;
      const r = document.getElementById('createRole').value;

      if (!uname || !pass) {
        setModalAlert('createUserAlert', 'Username & password wajib diisi', 'danger');
        return;
      }

      try {
        const resp = await fetch(`${API_URL}/admin/users?role=${role}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: uname, password: pass, role: r })
        });
        const data = await resp.json();
        if (resp.ok) {
          // tutup modal dan refresh user list
          const modalEl = document.getElementById('modalCreateUser');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();
          document.getElementById('formCreateUser').reset();
          loadUsers();
        } else {
          setModalAlert('createUserAlert', data.message || 'Gagal membuat user', 'danger');
        }
      } catch (err) {
        console.error('createUser err', err);
        setModalAlert('createUserAlert', 'Gagal koneksi ke server', 'danger');
      }
    });

    // Open edit modal and fill data
    function openEditModal(btn) {
      const id = btn.getAttribute('data-id');
      const uname = btn.getAttribute('data-username');
      const r = btn.getAttribute('data-role') || 'user';

      document.getElementById('editUserId').value = id;
      document.getElementById('editUsername').value = uname;
      document.getElementById('editPassword').value = '';
      document.getElementById('editRole').value = r;

      const modalEl = document.getElementById('modalEditUser');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    // Submit edit
    document.getElementById('formEditUser').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('editUserId').value;
      const uname = document.getElementById('editUsername').value.trim();
      const pass = document.getElementById('editPassword').value;
      const r = document.getElementById('editRole').value;

      if (!id || !uname) {
        setModalAlert('editUserAlert', 'Data tidak lengkap', 'danger');
        return;
      }

      // siapkan payload (jika password dikosongkan backend harus handle: jangan ubah)
      const payload = { username: uname, role: r };
      if (pass && pass.length > 0) payload.password = pass;

      try {
        const resp = await fetch(`${API_URL}/admin/users/${id}?role=${role}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (resp.ok) {
          const modalEl = document.getElementById('modalEditUser');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();
          loadUsers();
        } else {
          setModalAlert('editUserAlert', data.message || 'Gagal update user', 'danger');
        }
      } catch (err) {
        console.error('editUser err', err);
        setModalAlert('editUserAlert', 'Gagal koneksi ke server', 'danger');
      }
    });

    // DELETE user
    async function deleteUser(id) {
      if (!confirm('Hapus user ini? Tindakan tidak bisa dikembalikan.')) return;
      try {
        const resp = await fetch(`${API_URL}/admin/users/${id}?role=${role}`, { method: 'DELETE' });
        if (resp.ok) {
          loadUsers();
        } else {
          const data = await resp.json();
          alert(data.message || 'Gagal menghapus user');
        }
      } catch (err) {
        console.error('deleteUser err', err);
        alert('Gagal koneksi ke server');
      }
    }

    // Tombol refresh
    document.getElementById('btnRefreshSensor').addEventListener('click', loadSensorData);
    document.getElementById('btnRefreshUsers').addEventListener('click', loadUsers);

    // Auto-refresh sensor (5s)
    setInterval(loadSensorData, 5000);

    // Load awal
    loadSensorData();
    loadUsers();

  </script>
</body>
</html>
